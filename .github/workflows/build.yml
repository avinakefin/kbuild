name: kbuild

on:
  push:

jobs:
  super-job:
      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v2
      - name: Setup
        run: |
       sudo apt-get update && apt upgrade -y
msg "Installing essential packages..."
sudo apt-get install -y --no-install-recommends git make bc bison openssl \
    curl zip kmod cpio flex libelf-dev libssl-dev libtfm-dev wget \
    device-tree-compiler ca-certificates python3 python2
ln -sf "/usr/bin/python${python_version}" /usr/bin/python
set_output hash "$(cd "$kernel_path" && git rev-parse HEAD || exit 127)"
          
      - name: Build & Push
        run: |
          git config --global user.name "${GITHUB_USER}"
          git config --global user.email "${GITHUB_EMAIL}"
          source env.sh
          echo "Cloning kernel"
          git clone --depth=1 $KERNEL_REPO -b $KERNEL_BRANCH kernel && cd kernel
          mv /home/runner/work/kbuild/kbuild/bul.sh /home/runner/work/kbuild/kbuild/kernel
          source bul.sh

        env:
          GITHUB_EMAIL: ${{ secrets.EMAIL }}
          GITHUB_TOKEN: ${{ secrets.API_TOKEN_GITHUB }}
          GITHUB_USER: ${{ secrets.USERNAME }}
          TG_CHAT_ID: ${{ secrets.CHAT_ID }}
          TG_TOKEN: ${{ secrets.TOKEN }}
          KERNEL_SOURCE: ${{ secrets.KERNEL_SOURCE }}
          KERNEL_DEFCONFIG: ${{ secrets.KERNEL_DEFCONFIG }}
          HOST: ${{ secrets.HOST }}
          BUILD_USER: ${{ secrets.BUILD_USER }}
          ZIPNAME: ${{ secrets.ZIPNAME }}
      - uses: yanzay/notify-telegram@v0.1.0
        if: always()
        with:
          chat: ${{ secrets.CHAT_ID }} # user id or channel name secret
          token: ${{ secrets.TOKEN }} # token secret
          status: ${{ job.status }} # do not modify this line
